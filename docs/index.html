<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air Quality PWA</title>
<style>
  body {font-family:Arial,sans-serif;margin:2rem;}
  input, button {padding:0.5rem;margin:0.3rem;}
</style>
</head>
<body>
<h1>Air Quality PWA (MVP)</h1>
<p>Если вы видите этот текст, ваш фронтенд работает.</p>

<label for="city">Город:</label>
<input type="text" id="city" placeholder="например, London">
<button id="subscribeBtn">Подписаться на уведомления</button>

<div id="status"></div>

<script>
// ---------- Service Worker registration ----------
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.error('SW registration failed:', err));
  });
} else {
  console.warn('Service Worker not supported');
}

// ---------- Helper: convert base64 VAPID key ----------
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/\-/g, '+')
    .replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// ---------- Push subscription ----------
document.getElementById('subscribeBtn').addEventListener('click', async () => {
  const statusEl = document.getElementById('status');
  const city = document.getElementById('city').value.trim();

  if (!city) {
    statusEl.textContent = 'Введите название города.';
    return;
  }

  // 1. Запросить разрешение
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    statusEl.textContent = 'Разрешение на уведомления отклонено.';
    return;
  }

  // 2. Получить push‑подписку
  const registration = await navigator.serviceWorker.ready;
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array('BEOEWEA3tXPA3LRFcwLY7D6-pGzQENOAWqX_H3sJZ-Mgf9WtA8DeBaeGK1uloCNSYK6Aer-3NWv9HwGjiRQB7rI') // ← сюда вставьте публичный ключ
  });

  // 3. Отправить подписку на бекенд
  try {
    const resp = await fetch('/api/subscribe', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({city, subscription})
    });
    if (resp.ok) {
      statusEl.textContent = `Подписка оформлена! Вы будете получать уведомления о ${city}.`;
    } else {
      statusEl.textContent = 'Ошибка при сохранении подписки (сервер не отвечает).';
    }
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Сбой сети при отправке подписки.';
  }
});
</script>
</body>
</html>